<template>
  <!-- <el-scrollbar class="notice"> -->
  <el-tabs v-model="showFlag.show_num" @tab-click="tabClick">
    <!--       ç½‘ç«™ä»‹ç»åŒº-->
    <el-tab-pane :name="1" label="ç½‘ç«™ä»‹ç»">
      <el-collapse-transition class="noticeContent">
        <el-collapse v-model="showFlag.active_num" accordion>
          <el-collapse-item title="ç½‘ç«™ä»‹ç»" :name="1">
            <el-card class="introduction">
              <el-text tag="p">
                1.æœ¬ç«™ä¸ºç¤¾äº¤åŒ–å¯¼èˆªç½‘ç«™ï¼Œæä¾›
                <el-button link title="é¦–é¡µå¯¼èˆª" type="primary" @click="router.push({ name: 'home' })">ç«™ç‚¹å¯¼èˆª
                </el-button>
                ã€
                <el-button link title="è®ºå›æ–‡ç« " type="primary" target="_blank" @click="router.push({ name: 'forum' })">
                  è®ºå›äº¤æµ
                </el-button>
                ã€
                <el-button link title="é‡è¿”æœªæ¥ç›¸å…³ç•Œé¢" type="primary" @click="router.push({ name: 'reverse1999' })">
                  é‡è¿”æœªæ¥å®˜å›¾ç­›é€‰å’Œä¸‹è½½
                </el-button>
                ã€
                <el-button link title="åœ¨çº¿éŸ³ä¹æ’­æ”¾" type="primary" @click="router.push({ name: 'music' })">
                  åœ¨çº¿éŸ³ä¹æ’­æ”¾
                </el-button>
                ç­‰åŠŸèƒ½ã€‚
              </el-text>
              <el-text tag="p">
                2.å·¥å…·èµ„æºç¾¤ï¼š
                <el-button link target="_blank" type="primary"
                  @click="copyText('1005993749', 'QQç¾¤å·', 'https://qm.qq.com/cgi-bin/qm/qr?k=64Jtp9gH81G0ndqR_TGeUZLrP_MKE9eU&jump_from=webapi&authKey=BkihB0yK7m3dhvou57J/OPWP+7BsDBirgRKjud/BIWnXa9pM40wSwo0ORdMHlE5V')"
                  title="ç‚¹å‡»å‰å¾€QQ">Resource sharingç¾¤
                </el-button>
                ã€é‡è¿”æœªæ¥ç¾¤ï¼š
                <el-button link target="_blank" type="primary"
                  @click="copyText('904688184', 'QQç¾¤å·', 'https://qm.qq.com/q/Oq8R7YS6sM')" title="ç‚¹å‡»å‰å¾€QQ">
                  é‡‘å…”å­ç‰¹ä¾›éƒ¨é—¨ğŸ°
                </el-button>
                ,
                <el-text style="color: orangered">èµ„æºæ¥è‡ªç½‘ç»œ,ä¾µæƒè¯·è”ç³»åˆ é™¤</el-text>
                ã€‚
              </el-text>
              <el-text tag="p">
                3.è‹¥é¦–é¡µå¯¼èˆªç½‘ç«™æ— æ³•è®¿é—®ï¼Œè¯·ä½¿ç”¨Chromeã€Edgeã€Firefoxç­‰æµè§ˆå™¨æˆ–å°è¯•VPNï¼Œä¹Ÿå¯èƒ½æ˜¯å› ä¸ºè¯¥ç½‘ç«™ç»´æŠ¤ä¸­ã€ä¹Ÿå¯èƒ½æ˜¯ç½‘ç«™å·²å…³é—­ï¼Œå¤ªä¹…æ²¡æ ¡éªŒäº†ã€‘ã€‚
              </el-text>
              <el-text tag="p">4.ä½ å¯ä»¥
                <el-text tag="a" type="success"
                  href="https://mp-00526be3-cd12-41bd-84f7-bfbce63bb7d0.cdn.bspapp.com/test1/BookMarks_2023_8_15_2.zip"
                  title="ä¸‹è½½ä¹¦ç­¾">ä¸‹è½½
                </el-text>
                å¹¶è§£å‹å‡ºHTMLæ–‡ä»¶ï¼Œå¯¼å…¥åˆ°è‡ªå·±çš„æµè§ˆå™¨æ”¶è—å¤¹ã€‚å¯¼å…¥æ­¥éª¤å¯å‚è€ƒç›¸å…³æ•™ç¨‹è§†é¢‘ï¼š
                <el-text tag="a" target="_blank" type="primary" href="https://www.bilibili.com/video/BV1rr4y1S79J/"
                  title="Bç«™æ•™ç¨‹è§†é¢‘">ç‚¹å‡»æ­¤å¤„
                </el-text>
                ã€‚
              </el-text>
              <el-text tag="p">
                5.æœ¬ç«™æ­£åœ¨æŒç»­æ›´æ–°å’Œé€‚é…ç§»åŠ¨ç«¯ï¼Œå¦‚
                <el-text type="warning">UIé”™ä½</el-text>
                æˆ–
                <el-text type="danger">åŠŸèƒ½å‡ºé”™</el-text>
                è¯·
                <el-button link title="å‰å¾€åé¦ˆ" type="primary" @click="changePage(3, 2)">ç•™è¨€åé¦ˆ</el-button>
                ã€‚
              </el-text>
            </el-card>
          </el-collapse-item>
          <el-collapse-item title="å‹æƒ…é“¾æ¥" :name="2">
            <template class="friendLinks">
              <el-link target="_blank" href="https://letsgofishing5.github.io/lsgfish-resource-sharing/"
                title="èµ„æºæ”¶è—ä¸åˆ†äº«">
                <el-button><img src="../assets/home/custom.png" alt="" style="width: 25px">&ensp;
                  lsgfish-resource-sharing
                </el-button>
              </el-link>
              <el-link target="_blank" v-if="false" href="https://answer.lilemy.cn/" title="å°æ–°é—®ç­”">
                <el-button><img src="@/assets/logo.xiaoxin.png" alt="" style="width: 25px">&ensp;
                  å°æ–°é—®ç­”
                </el-button>
              </el-link>
            </template>
          </el-collapse-item>
          <el-collapse-item title="éšç§æ”¿ç­–" :name="3">
            <el-card class="privacyStatement">
              <p>
                æœ¬ç«™ä¸ Microsoft Clarity åˆä½œï¼Œé€šè¿‡è¡Œä¸ºæŒ‡æ ‡ã€çƒ­å›¾å’Œä¼šè¯å›æ”¾æ¥æ•æ‰æ‚¨ä½¿ç”¨æœ¬ç«™çš„è½¨è¿¹ï¼Œä»¥æ”¹è¿›æœ¬ç«™çš„äº§å“å’ŒæœåŠ¡ã€‚ç½‘ç«™ä½¿ç”¨æ•°æ®æ˜¯é€šè¿‡ç¬¬ä¸€æ–¹å’Œç¬¬ä¸‰æ–¹
                Cookie ä»¥åŠå…¶ä»–è·Ÿè¸ªæŠ€æœ¯æ•è·çš„ï¼Œä»¥ç¡®å®šäº§å“å’ŒæœåŠ¡çš„å—æ¬¢è¿ç¨‹åº¦å’Œåœ¨çº¿æ´»åŠ¨ã€‚æ­¤å¤–ï¼Œæœ¬ç«™å°†è¿™äº›ä¿¡æ¯ç”¨äºç½‘ç«™ä¼˜åŒ–ã€‚æœ‰å…³
                Microsoft å¦‚ä½•æ”¶é›†å’Œä½¿ç”¨æ‚¨çš„æ•°æ®çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®
                <el-button link type="primary" :href="'https://privacy.microsoft.com/zh-CN/privacystatement'">Microsoft
                  éšç§å£°æ˜
                </el-button>ã€‚
              </p>
              <p>
                è‹¥æ‚¨åŒæ„ï¼Œåˆ™æœ¬ç«™å’Œ Microsoft å¯ä»¥æ”¶é›†å’Œä½¿ç”¨æ­¤æ•°æ®ã€‚æ‚¨ä¹Ÿå¯ä»¥ç‚¹å‡»æ­¤å¤„<el-button link type="primary"
                  @click="clear_Clarity_cookie()">é‡ç½®Clarityçš„cookieåŒæ„
                </el-button>ã€‚
              </p>
              <p><b>
                  PS:æ ¹æ®å›½å®¶æ³•å¾‹æ³•è§„ï¼Œæœ¬ç«™ä»…æ”¶é›†è®¿é—®è€…IPç­‰èº«ä»½ä¿¡æ¯ã€‚æ­¤å¤–ï¼Œæœ¬ç«™ä½¿ç”¨Clarityæ”¶é›†è®¿é—®è€…åœ¨æœ¬ç«™çš„æµè§ˆè½¨è¿¹ä»¥ç¡®å®šbugä½ç½®è¿›è¡Œä¼˜åŒ–ï¼Œç›¸å…³çš„è´¦å·ã€å¯†ç ç­‰éšç§ä¿¡æ¯å‡ä¸ä¼šè¢«é‡‡é›†ã€‚
                </b>
              </p>
            </el-card>
          </el-collapse-item>
        </el-collapse>
      </el-collapse-transition>
    </el-tab-pane>
    <!--    æ›´æ–°ç›¸å…³-->
    <el-tab-pane :name="2" label="æ›´æ–°ç›¸å…³">
      <el-collapse-transition class="noticeContent">
        <el-collapse v-model="showFlag.active_num" accordion style="border: none;text-align: left">
          <!--    å¾…æ›´æ–°çš„åŠŸèƒ½-->
          <el-collapse-item title="å¾…æ›´æ–°çš„åŠŸèƒ½" :name="1">
            <template v-for="item in noUpdated" :key="item.id">
              <el-button text :icon="Edit">{{ item.content }}</el-button>
              <br>
            </template>
          </el-collapse-item>
          <el-collapse-item title="å·²æ›´æ–°çš„å…¬å‘Š" :name="2">
            <el-timeline style="padding-left: 0"><br>
              <el-timeline-item v-for="item in updateNotes.slice().reverse()" :key="item.id" style="text-align: left"
                :timestamp="item.time" placement="top">
                <el-card>
                  <el-text tag="p"> {{ item.title }}</el-text>
                  <el-text tag="p" type="info"> &ensp;{{ item.content }}</el-text>
                </el-card>
              </el-timeline-item>
            </el-timeline>
          </el-collapse-item>
        </el-collapse>
      </el-collapse-transition>
    </el-tab-pane>
    <!--è”ç³»å’Œåé¦ˆ-->
    <el-tab-pane :name="3" label="è”ç³»å’Œåé¦ˆ">
      <el-collapse-transition class="noticeContent">
        <el-collapse v-model="showFlag.active_num" v-show="showFlag.show_num === 3" accordion style="border: none">
          <!--è”ç³»æ–¹å¼-->
          <el-collapse-item title="è”ç³»æ–¹å¼" :name="1">
            <template style="display: flex;justify-content: space-around">
              <el-button link tag="a" type="primary"
                @click="copyText('50011502001039', 'QQå·', 'tencent://message/?uin=1224021291')">QQ
              </el-button>
              <el-button link tag="a" type="primary"
                @click="copyText('50011502001039', 'å¾®åšä¸»é¡µé“¾æ¥', 'https://weibo.com/u/6869134755')">å¾®åš
              </el-button>
            </template>

          </el-collapse-item>
          <!--    ç•™è¨€åé¦ˆ-->
          <el-collapse-item title="ç•™è¨€åé¦ˆ" :name="2">
            <el-form style="margin: 0 5%">
              <el-form-item>
                <el-input type="text" v-model.trim="contact" maxlength="30" placeholder="[é€‰å¡«]å¯åœ¨æ­¤å¡«å†™è”ç³»æ–¹å¼"></el-input>
              </el-form-item>
              <el-form-item>
                <el-input type="textarea" v-model.trim="content" minlength="5" maxlength="200" :autosize="true"
                  show-word-limit placeholder="[å¿…å¡«]å¯åœ¨æ­¤æäº¤å»ºè®®ã€bugåé¦ˆæˆ–å…¶ä»–å†…å®¹" />
              </el-form-item>
            </el-form>
            <el-button type="primary" @click="submitFeedback">æäº¤åé¦ˆ</el-button>
          </el-collapse-item>
        </el-collapse>
      </el-collapse-transition>
    </el-tab-pane>
  </el-tabs>
  <!--å¤‡æ¡ˆå·-->
  <Approve />
  <!--    <el-divider>å·²åŠ è½½å…¨éƒ¨å†…å®¹</el-divider>-->
  <!-- </el-scrollbar> -->
</template>

<script setup lang="ts">
import { useRouter } from "vue-router";
import axios from "axios";
import { onMounted, reactive, ref } from "vue";
import { Edit } from "@element-plus/icons-vue";
import { ElCollapseTransition, ElMessage, TabsPaneContext } from 'element-plus'
//hooks
import useTimeStamp from "@/hooks/useTimestamp";
//components
import Approve from "@/components/Approve.vue";
//utils
import myFunction from "@/utils/myFunction";
//types
import { Notice } from "@/types/global";


const { copyText } = myFunction
const { getDiffTime } = useTimeStamp()
const router = useRouter()

const { showFlag, changePage } = defineProps(['showFlag', 'changePage'])//åˆ‡æ¢é¡µé¢çš„å‚æ•°

const updateNotes = reactive<Notice[]>([])//å·²æ›´æ–°çš„å…¬å‘Š
const noUpdated = reactive<Notice[]>([])//æœªæ›´æ–°çš„å…¬å‘Š
const contact = ref('')//åé¦ˆè”ç³»æ–¹å¼
const content = ref('')//åé¦ˆå†…å®¹


onMounted(() => {
  getNotices()//è·å–å…¬å‘Š
})

/*ç‚¹å‡»tabsæ ‡ç­¾æ—¶è§¦å‘*/
const tabClick = (pane: TabsPaneContext, ev: Event) => {
  if (pane.paneName === 1) changePage(1, 1)
  else changePage(pane.paneName, 2)
}

//è·å–å·²å‘å¸ƒå…¬å‘Š
const getNotices = async () => {
  try {
    const result = await axios({
      url: '/getNotices',
      params: { sort: ['updateNotes', 'noUpdated'] }
    })
    // console.log(result)
    const { noticeList } = result.data
    updateNotes.splice(0, updateNotes.length)
    noUpdated.splice(0, noUpdated.length)
    noticeList.forEach((item: Notice) => {
      if (item.created_time === item.updated_time) item.time = 'å‘å¸ƒæ—¶é—´ï¼š' + getDiffTime(item.created_time)
      else item.time = 'å‘å¸ƒæ—¶é—´ï¼š' + getDiffTime(item.created_time) + '  ä¸Šæ¬¡ä¿®è®¢äºï¼š' + getDiffTime(item.updated_time)
      if (item.sort === 'updateNotes') updateNotes.push(item)
      if (item.sort === 'noUpdated') noUpdated.push(item)
    })
  } catch (error) {
    console.log('å‘ç”Ÿé”™è¯¯ï¼š')
    console.dir(error)
  }
}


//ä¸Šä¼ åé¦ˆå†…å®¹
const submitFeedback = async () => {
  console.log(content.value.length)
  if (content.value === '') return ElMessage.error('åé¦ˆå†…å®¹ä¸èƒ½ä¸ºç©º')
  if (contact.value.length > 30) return ElMessage.error('è”ç³»æ–¹å¼è¶…å‡ºé•¿åº¦é™åˆ¶')
  if (content.value.length < 5 || content.value.length > 200) return ElMessage.error('åé¦ˆå†…å®¹åº”ä¸º5-200ä¸ªå­—ç¬¦')
  try {
    const result = await axios({
      url: '/submitFeedback',
      method: 'post',
      data: {
        contact: contact.value,
        content: content.value
      }
    })
    console.log('result', result)
    contact.value = ''
    content.value = ''
    ElMessage.success(result.data.msg)
  } catch (error) {
    console.log('å‘ç”Ÿé”™è¯¯ï¼š')
    console.dir(error)
  }
}


//æ¸…é™¤å…¨éƒ¨cookie
const delAllCookie = () => {
  const cookies = document.cookie.split(";")

  cookies.forEach(cookie => {
    const [name] = cookie.split("=");
    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
  })

  if (cookies.length > 0) {
    const domain = `.${location.host.split('.').slice(-2).join('.')}` // é¡¶çº§åŸŸå
    cookies.forEach(cookie => {
      const [name] = cookie.split("=")
      document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; domain=${domain}`
    })
  }
  console.log('å·²åˆ é™¤å…¨éƒ¨æœ¬åœ°cookie');
}
const clear_Clarity_cookie = () => {
  // window.clarity('consent', false)
  delAllCookie()
  ElMessage.success('å·²é‡ç½®åŒæ„ï¼Œåˆ·æ–°åå¯é€‰æ‹©æ‹’ç»cookie')
  setTimeout(() => { location.reload() }, 1500)
}
</script>

<style scoped>
.noticeContent {
  height: 300px;
  overflow-y: scroll;
}

.friendLinks {
  display: flex;
  justify-content: flex-start;
}

.friendLinks .el-link {
  margin: 0 10px;
}

p {
  text-align: left;
  text-indent: 1em;
  word-spacing: 1px;

  .el-button {
    margin: 0;
    word-spacing: 0;
  }
}
</style>
